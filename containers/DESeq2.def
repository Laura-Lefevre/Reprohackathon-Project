# Type de base pour construire l’image Apptainer. Ici on part d’une image Docker existante
Bootstrap: docker
# Image de base
From: ubuntu:22.04

# Section métadonnées intégrées à l’image.
%labels
    Author "Saïda Moussaeva"
    Description "Minimal R + DESeq2 environment built from scratch"

# Bloc exécuté au moment du build : installation et configuration
%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    apt-get update
    apt-get install -y --no-install-recommends \
        wget \
        curl \
        ca-certificates \
        gnupg \
        software-properties-common \
        locales \
        libxml2-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libpng-dev \
        libjpeg-dev \
        libtiff5-dev \
        libfontconfig1-dev \
        libblas-dev \
        liblapack-dev \
        gfortran \
        build-essential

    locale-gen en_US.UTF-8

    # Clé CRAN propre (apt-key déprécié)
    curl -fsSL https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
      | gpg --dearmor -o /etc/apt/trusted.gpg.d/cran_ubuntu_key.gpg
    echo "deb [signed-by=/etc/apt/trusted.gpg.d/cran_ubuntu_key.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" \
      > /etc/apt/sources.list.d/cran.list

    apt-get update
    apt-get install -y --no-install-recommends r-base

    R -e "options(repos='https://cloud.r-project.org'); install.packages('BiocManager'); \
          BiocManager::install(c('DESeq2','tximport','apeglm','AnnotationDbi','org.Hs.eg.db','biomaRt','clusterProfiler','enrichplot','ComplexHeatmap'), ask=FALSE, update=FALSE); \
          install.packages(c('ggplot2','pheatmap','RColorBrewer','dplyr','tibble','ggrepel','ggpubr','readr','tidyr','reshape2','cowplot'), dependencies=TRUE)"

    apt-get clean
    rm -rf /var/lib/apt/lists/*


#Variables d’environnement au runtime (chaque exécution du conteneur)
%environment
    export LC_ALL=en_US.UTF-8 # utilisation econdage UTF-8
    export LANG=en_US.UTF-8 # langue système anglais
    export R_LIBS_USER=/usr/local/lib/R/site-library #indique à R où trouver ses bibliothèques installées

# Entrypoint du conteneur à l’exécution.
%runscript
    exec Rscript "$@"
