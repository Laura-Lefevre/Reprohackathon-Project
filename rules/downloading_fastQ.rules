import os

THREADS = config["THREADS"]
OUTDIR = config["OUTDIR"]

rule download_fastq:
    output:
        f"{OUTDIR}/{{srr}}.fastq"
    threads: THREADS
    shell:
        """
        echo "Downloading {wildcards.srr}..."
        mkdir -p {OUTDIR}

        if [ -f {output} ]; then
            echo "Existing file detected: deleting {output}"
            rm {output}
        fi

        fasterq-dump --threads {threads} --progress --outdir {OUTDIR} {wildcards.srr}

        TMPDIR=$(find {OUTDIR} -maxdepth 1 -type d -name "fasterq.tmp.*" | head -n 1)
        if [ -n "$TMPDIR" ]; then
            echo "Deleting temporary folder: $TMPDIR"
            rm -rf "$TMPDIR"
        fi

        echo "Download complete for {wildcards.srr}"
        """